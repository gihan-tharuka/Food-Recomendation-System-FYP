{% extends "staff-base.html" %}

{% block title %}Manage Menu - Staff Dashboard{% endblock %}

{% block page_title %}Manage Menu{% endblock %}

{% block extra_head %}
<style>
.modal {
    transition: opacity 0.25s ease;
}
.modal-body {
    transition: all 0.25s ease;
}
.table-hover tbody tr:hover {
    background-color: #f8fafc;
}
</style>
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Menu Management</h2>
            <p class="text-gray-600">Add, edit, and manage restaurant menu items</p>
        </div>
        <button onclick="openAddMenuModal()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center space-x-2">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Add Menu Item</span>
        </button>
    </div>

        <!-- Statistics Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Items</p>
                        <p id="total-items" class="text-2xl font-bold text-gray-900">---</p>
                    </div>
                    <i data-lucide="utensils" class="w-8 h-8 text-orange-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Cuisines</p>
                        <p id="total-cuisines" class="text-2xl font-bold text-gray-900">---</p>
                    </div>
                    <i data-lucide="globe" class="w-8 h-8 text-blue-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Categories</p>
                        <p id="total-categories" class="text-2xl font-bold text-gray-900">---</p>
                    </div>
                    <i data-lucide="tag" class="w-8 h-8 text-green-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Avg Price</p>
                        <p id="avg-price" class="text-2xl font-bold text-gray-900">---</p>
                    </div>
                    <i data-lucide="dollar-sign" class="w-8 h-8 text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
            <div class="grid md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                        <input type="text" id="search-input" placeholder="Search menu items..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cuisine</label>
                    <select id="cuisine-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="">All Cuisines</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="clearFilters()" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Menu Items Table -->
        <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Menu Items</h3>
            </div>
            
            <!-- Loading State -->
            <div id="loading-state" class="hidden p-8 text-center">
                <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-orange-600 bg-orange-100">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading menu items...
                </div>
            </div>

            <!-- Table -->
            <div id="table-container" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuisine</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Context Tags</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="menu-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Menu items will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div id="pagination-container" class="hidden px-6 py-4 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 text-sm text-gray-700">
                        <span>Showing</span>
                        <span id="items-start">1</span>
                        <span>to</span>
                        <span id="items-end">10</span>
                        <span>of</span>
                        <span id="total-items-count">0</span>
                        <span>items</span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-1 text-sm text-gray-700">
                            <span>Items per page:</span>
                            <select id="items-per-page" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-1">
                            <button id="prev-page" onclick="changePage(currentPage - 1)" 
                                    class="px-3 py-1 border border-gray-300 rounded text-sm bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            
                            <div id="page-numbers" class="flex items-center space-x-1">
                                <!-- Page numbers will be populated here -->
                            </div>
                            
                            <button id="next-page" onclick="changePage(currentPage + 1)" 
                                    class="px-3 py-1 border border-gray-300 rounded text-sm bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden p-8 text-center">
                <i data-lucide="utensils" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No menu items found</h3>
                <p class="text-gray-600 mb-4">Start by adding your first menu item to the system.</p>
                <button onclick="openAddMenuModal()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">
                    Add Menu Item
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Menu Item Modal -->
    <div id="menu-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="modal-body bg-white rounded-lg shadow-xl max-w-md w-full max-h-screen overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Add Menu Item</h3>
            </div>
            
            <form id="menu-form" class="p-6 space-y-4">
                <input type="hidden" id="item-id">
                
                <div>
                    <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">Item Name *</label>
                    <input type="text" id="item-name" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                           placeholder="Enter item name">
                </div>
                
                <div>
                    <label for="item-price" class="block text-sm font-medium text-gray-700 mb-1">Price *</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rs.</span>
                        <input type="number" id="item-price" required step="0.01" min="0"
                               class="w-full pl-12 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                               placeholder="0.00">
                    </div>
                </div>
                
                <div>
                    <label for="item-cuisine" class="block text-sm font-medium text-gray-700 mb-1">Cuisine *</label>
                    <input type="text" id="item-cuisine" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                           placeholder="e.g., Italian, Chinese, American">
                </div>
                
                <div>
                    <label for="item-category" class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                    <select id="item-category" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="">Select category</option>
                        <!-- Categories will be populated dynamically -->
                    </select>
                </div>
                
                <div>
                    <label for="item-image" class="block text-sm font-medium text-gray-700 mb-1">Menu Item Image</label>
                    <input type="file" id="item-image" accept="image/*"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                    <p class="text-xs text-gray-500 mt-1">Upload an image for this menu item (optional). Supported formats: JPEG, PNG, GIF</p>
                    <div id="current-image-preview" class="mt-2 hidden">
                        <img id="current-image" src="" alt="Current image" class="h-20 w-20 object-cover rounded-lg border">
                        <p class="text-xs text-gray-500 mt-1">Current image</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Tags</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="is-morning" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-700">Morning</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="is-afternoon" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-700">Afternoon</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="is-evening" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-700">Evening</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Weather Tags</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="is-sunny" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-700">Sunny</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="is-rainy" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-700">Rainy</span>
                        </label>
                    </div>
                </div>
            </form>
            
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" onclick="closeMenuModal()" 
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Cancel
                </button>
                <button type="submit" form="menu-form"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                    <span id="submit-text">Save Item</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="modal-body bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Delete Menu Item</h3>
                </div>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this menu item? This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeDeleteModal()" 
                            class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="fixed top-4 right-4 z-50"></div>

{% endblock %}

{% block scripts %}
<script>
let currentMenuItems = [];
let currentUser = null;
let itemToDelete = null;

// Pagination variables
let currentPage = 1;
let itemsPerPage = 10;
let filteredItems = [];

        function setupEventListeners() {
            // Search and filter
            document.getElementById('search-input').addEventListener('input', filterMenuItems);
            document.getElementById('cuisine-filter').addEventListener('change', filterMenuItems);
            document.getElementById('category-filter').addEventListener('change', filterMenuItems);

            // Form submission
            document.getElementById('menu-form').addEventListener('submit', handleMenuSubmit);
            
            // Pagination
            document.getElementById('items-per-page').addEventListener('change', function() {
                itemsPerPage = parseInt(this.value);
                currentPage = 1;
                displayMenuItems(filteredItems);
            });
        }

        function loadMenuItems() {
            showLoading();
            
            fetch('/api/menu-items')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        currentMenuItems = data.items;
                        filteredItems = [...currentMenuItems]; // Initialize filtered items
                        displayMenuItems(filteredItems);
                        updateStatistics(currentMenuItems);
                        populateFilters(currentMenuItems);
                    } else {
                        showMessage('Failed to load menu items: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error loading menu items:', error);
                    showMessage('Error loading menu items: ' + error.message, 'error');
                });
        }

        function displayMenuItems(items) {
            const tbody = document.getElementById('menu-table-body');
            
            if (items.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('table-container').classList.add('hidden');
                document.getElementById('pagination-container').classList.add('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('table-container').classList.remove('hidden');
            document.getElementById('pagination-container').classList.remove('hidden');
            
            // Calculate pagination
            const totalItems = items.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const currentItems = items.slice(startIndex, endIndex);
            
            // Update pagination info
            document.getElementById('items-start').textContent = totalItems > 0 ? startIndex + 1 : 0;
            document.getElementById('items-end').textContent = endIndex;
            document.getElementById('total-items-count').textContent = totalItems;
            
            // Debug: Log the items to see what data we're getting
            console.log('Menu items received:', currentItems);
            
            tbody.innerHTML = currentItems.map(item => {
                const contextTags = [];
                if (item.is_morning) contextTags.push('Morning');
                if (item.is_afternoon) contextTags.push('Afternoon');
                if (item.is_evening) contextTags.push('Evening');
                if (item.is_sunny) contextTags.push('Sunny');
                if (item.is_rainy) contextTags.push('Rainy');
                
                // Handle image display
                const hasImage = item.image_url && 
                               item.image_url !== '' && 
                               item.image_url !== 'null' && 
                               item.image_url !== null && 
                               item.image_url !== undefined;
                
                const imageDisplay = hasImage ? 
                    `<img src="${item.image_url}" alt="${item.item_name}" class="w-12 h-12 object-cover rounded-lg border" onerror="console.error('Image failed to load:', '${item.image_url}'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center" style="display:none;">
                        <i data-lucide="image" class="w-6 h-6 text-gray-400"></i>
                     </div>` :
                    `<div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                        <i data-lucide="image" class="w-6 h-6 text-gray-400"></i>
                    </div>`;
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.item_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${imageDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.item_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Rs. ${parseFloat(item.price).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.cuisine || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.category || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${contextTags.length > 0 ? 
                                contextTags.map(tag => `<span class="inline-flex px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded-full mr-1 mb-1">${tag}</span>`).join('') 
                                : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editMenuItem(${item.item_id})" 
                                    class="text-orange-600 hover:text-orange-900 mr-3">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteMenuItem(${item.item_id})" 
                                    class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination controls
            updatePaginationControls(totalPages);
            
            lucide.createIcons();
        }

        function updateStatistics(items) {
            const totalItems = items.length;
            const cuisines = [...new Set(items.map(item => item.cuisine).filter(Boolean))];
            const categories = [...new Set(items.map(item => item.category).filter(Boolean))];
            const avgPrice = items.length > 0 ? items.reduce((sum, item) => sum + parseFloat(item.price || 0), 0) / items.length : 0;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-cuisines').textContent = cuisines.length;
            document.getElementById('total-categories').textContent = categories.length;
            document.getElementById('avg-price').textContent = 'Rs. ' + avgPrice.toFixed(2);
        }

        function populateFilters(items) {
            const cuisines = [...new Set(items.map(item => item.cuisine).filter(Boolean))].sort();
            const categories = [...new Set(items.map(item => item.category).filter(Boolean))].sort();

            const cuisineFilter = document.getElementById('cuisine-filter');
            const categoryFilter = document.getElementById('category-filter');

            cuisineFilter.innerHTML = '<option value="">All Cuisines</option>' +
                cuisines.map(cuisine => `<option value="${cuisine}">${cuisine}</option>`).join('');

            categoryFilter.innerHTML = '<option value="">All Categories</option>' +
                categories.map(category => `<option value="${category}">${category}</option>`).join('');
            
            // Also populate the form category dropdown
            populateFormCategories(categories);
        }
        
        function populateFormCategories(categories) {
            const formCategorySelect = document.getElementById('item-category');
            
            // Keep the first "Select category" option and add the actual categories
            formCategorySelect.innerHTML = '<option value="">Select category</option>' +
                categories.map(category => `<option value="${category}">${category}</option>`).join('');
        }

        function filterMenuItems() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const cuisineFilter = document.getElementById('cuisine-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;

            filteredItems = currentMenuItems.filter(item => {
                const matchesSearch = item.item_name.toLowerCase().includes(searchTerm);
                const matchesCuisine = !cuisineFilter || item.cuisine === cuisineFilter;
                const matchesCategory = !categoryFilter || item.category === categoryFilter;

                return matchesSearch && matchesCuisine && matchesCategory;
            });

            currentPage = 1; // Reset to first page when filtering
            displayMenuItems(filteredItems);
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('cuisine-filter').value = '';
            document.getElementById('category-filter').value = '';
            filteredItems = [...currentMenuItems]; // Reset filtered items
            currentPage = 1; // Reset to first page
            displayMenuItems(filteredItems);
        }

        // Pagination Functions
        function updatePaginationControls(totalPages) {
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            
            // Update prev/next buttons
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalPages === 0;
            
            // Generate page numbers
            pageNumbers.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Calculate page range to show
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            // Show first page and ellipsis if needed
            if (startPage > 1) {
                pageNumbers.appendChild(createPageButton(1));
                if (startPage > 2) {
                    pageNumbers.appendChild(createEllipsis());
                }
            }
            
            // Show page numbers
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.appendChild(createPageButton(i));
            }
            
            // Show ellipsis and last page if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbers.appendChild(createEllipsis());
                }
                pageNumbers.appendChild(createPageButton(totalPages));
            }
        }
        
        function createPageButton(pageNum) {
            const button = document.createElement('button');
            button.textContent = pageNum;
            button.className = `px-3 py-1 border text-sm ${
                currentPage === pageNum 
                    ? 'bg-orange-600 text-white border-orange-600' 
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
            }`;
            button.onclick = () => changePage(pageNum);
            return button;
        }
        
        function createEllipsis() {
            const span = document.createElement('span');
            span.textContent = '...';
            span.className = 'px-2 py-1 text-gray-500';
            return span;
        }
        
        function changePage(newPage) {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            
            if (newPage < 1 || newPage > totalPages) return;
            
            currentPage = newPage;
            displayMenuItems(filteredItems);
        }

        function openAddMenuModal() {
            document.getElementById('modal-title').textContent = 'Add Menu Item';
            document.getElementById('submit-text').textContent = 'Save Item';
            document.getElementById('menu-form').reset();
            document.getElementById('item-id').value = '';
            
            // Hide image preview for new items
            document.getElementById('current-image-preview').classList.add('hidden');
            
            // Ensure categories are populated (in case modal is opened before data is loaded)
            if (currentMenuItems.length > 0) {
                const categories = [...new Set(currentMenuItems.map(item => item.category).filter(Boolean))].sort();
                populateFormCategories(categories);
            }
            
            document.getElementById('menu-modal').classList.remove('hidden');
            document.getElementById('menu-modal').classList.add('flex');
        }

        function editMenuItem(itemId) {
            const item = currentMenuItems.find(i => i.item_id === itemId);
            if (!item) return;

            document.getElementById('modal-title').textContent = 'Edit Menu Item';
            document.getElementById('submit-text').textContent = 'Update Item';
            
            // Ensure categories are populated first
            const categories = [...new Set(currentMenuItems.map(item => item.category).filter(Boolean))].sort();
            populateFormCategories(categories);
            
            document.getElementById('item-id').value = item.item_id;
            document.getElementById('item-name').value = item.item_name;
            document.getElementById('item-price').value = item.price;
            document.getElementById('item-cuisine').value = item.cuisine || '';
            document.getElementById('item-category').value = item.category || '';
            
            document.getElementById('is-morning').checked = item.is_morning || false;
            document.getElementById('is-afternoon').checked = item.is_afternoon || false;
            document.getElementById('is-evening').checked = item.is_evening || false;
            document.getElementById('is-sunny').checked = item.is_sunny || false;
            document.getElementById('is-rainy').checked = item.is_rainy || false;
            
            // Show current image preview if exists
            const imagePreview = document.getElementById('current-image-preview');
            const currentImage = document.getElementById('current-image');
            if (item.image_url) {
                currentImage.src = item.image_url;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.classList.add('hidden');
            }
            
            // Clear file input
            document.getElementById('item-image').value = '';

            document.getElementById('menu-modal').classList.remove('hidden');
            document.getElementById('menu-modal').classList.add('flex');
        }

        function closeMenuModal() {
            document.getElementById('menu-modal').classList.add('hidden');
            document.getElementById('menu-modal').classList.remove('flex');
            
            // Reset form
            document.getElementById('menu-form').reset();
            document.getElementById('modal-title').textContent = 'Add Menu Item';
            document.getElementById('submit-text').textContent = 'Save Item';
            document.getElementById('item-id').value = '';
            
            // Hide image preview
            document.getElementById('current-image-preview').classList.add('hidden');
        }

        function handleMenuSubmit(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('item-id').value;
            const imageFile = document.getElementById('item-image').files[0];
            
            // Use FormData for file uploads
            const formData = new FormData();
            formData.append('item_name', document.getElementById('item-name').value);
            formData.append('price', document.getElementById('item-price').value);
            formData.append('cuisine', document.getElementById('item-cuisine').value);
            formData.append('category', document.getElementById('item-category').value);
            formData.append('is_morning', document.getElementById('is-morning').checked);
            formData.append('is_afternoon', document.getElementById('is-afternoon').checked);
            formData.append('is_evening', document.getElementById('is-evening').checked);
            formData.append('is_sunny', document.getElementById('is-sunny').checked);
            formData.append('is_rainy', document.getElementById('is-rainy').checked);
            
            // Add image file if selected
            if (imageFile) {
                formData.append('image', imageFile);
            }

            const url = itemId ? `/api/menu-items/${itemId}` : '/api/menu-items';
            const method = itemId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                body: formData  // Don't set Content-Type header, let browser set it with boundary
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(itemId ? 'Menu item updated successfully!' : 'Menu item added successfully!', 'success');
                    closeMenuModal();
                    loadMenuItems();
                } else {
                    showMessage(data.message || 'Failed to save menu item', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving menu item:', error);
                showMessage('Error saving menu item: ' + error.message, 'error');
            });
        }

        function deleteMenuItem(itemId) {
            itemToDelete = itemId;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('delete-modal').classList.add('flex');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            document.getElementById('delete-modal').classList.remove('flex');
            itemToDelete = null;
        }

        function confirmDelete() {
            if (!itemToDelete) return;

            fetch(`/api/menu-items/${itemToDelete}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Menu item deleted successfully!', 'success');
                    closeDeleteModal();
                    loadMenuItems();
                } else {
                    showMessage(data.message || 'Failed to delete menu item', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting menu item:', error);
                showMessage('Error deleting menu item: ' + error.message, 'error');
            });
        }

        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('table-container').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-state').classList.add('hidden');
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700';
            
            messageDiv.className = `border-l-4 p-4 mb-4 ${bgColor}`;
            messageDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <p>${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(messageDiv);
            lucide.createIcons();
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Initialize page when DOM content is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadMenuItems();
            setupEventListeners();
        });
</script>
{% endblock %}
