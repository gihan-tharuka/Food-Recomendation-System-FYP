{% extends "base.html" %}

{% block title %}üìù Register - Food Recommendation System{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8">
    <div class="text-center mb-8">
        <div class="bg-food-orange bg-opacity-20 rounded-full p-4 w-16 h-16 mx-auto mb-4">
            <i data-lucide="user-plus" class="w-8 h-8 text-food-orange mx-auto"></i>
        </div>
        <h2 class="text-3xl font-bold text-gray-800">Create Account</h2>
        <p class="text-gray-600 mt-2">Join us for personalized food recommendations</p>
    </div>
    
    <form id="register-form" class="space-y-6">
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
            <input type="text" id="name" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-food-orange focus:border-transparent transition-colors"
                   placeholder="Enter your full name">
        </div>
        
        <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
            <input type="email" id="email" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-food-orange focus:border-transparent transition-colors"
                   placeholder="Enter your email address">
        </div>
        
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <input type="password" id="password" required minlength="6"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-food-orange focus:border-transparent transition-colors"
                   placeholder="Create a password (min. 6 characters)">
        </div>
        
        <div>
            <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Account Type</label>
            <select id="role" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-food-orange focus:border-transparent transition-colors">
                <option value="customer">Customer - Get food recommendations</option>
                <option value="staff">Restaurant Staff - Manage the system</option>
            </select>
        </div>
        
        <button type="submit" 
                class="w-full bg-food-orange text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors flex items-center justify-center space-x-2">
            <i data-lucide="user-plus" class="w-5 h-5"></i>
            <span>Create Account</span>
        </button>
    </form>
    
    <div class="mt-8 text-center">
        <p class="text-gray-600">Already have an account?</p>
        <a href="/login" class="text-food-green hover:text-green-600 font-semibold transition-colors">
            Sign in instead
        </a>
    </div>
    
    <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-start">
            <i data-lucide="shield-check" class="w-5 h-5 text-green-600 mr-2 mt-0.5"></i>
            <div class="text-sm text-green-700">
                <strong>Privacy:</strong> Your information is secure and will only be used to improve your food recommendations.
            </div>
        </div>
    </div>
    
    <!-- Success Message Container -->
    <div id="success-message" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-start">
            <i data-lucide="check-circle" class="w-5 h-5 text-blue-600 mr-2 mt-0.5"></i>
            <div class="text-sm text-blue-700">
                <strong>Account Created!</strong> 
                <div class="mt-2">
                    <p>Your User ID is: <span id="user-id-display" class="font-mono bg-blue-100 px-2 py-1 rounded"></span></p>
                    <p class="text-xs mt-1">Please save this ID - you'll need it to log in!</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('register-form').addEventListener('submit', function(e) {
    e.preventDefault();
    registerUser();
});

function registerUser() {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const role = document.getElementById('role').value;
    
    if (!name || !email || !password) {
        showMessage('Please fill in all fields', 'error');
        return;
    }
    
    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showMessage('Please enter a valid email address', 'error');
        return;
    }
    
    // Password validation
    if (password.length < 6) {
        showMessage('Password must be at least 6 characters long', 'error');
        return;
    }
    
    showLoading('Creating account...');
    
    fetch('/api/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: name, email: email, password: password, role: role })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            // Store user data in sessionStorage
            sessionStorage.setItem('currentUser', JSON.stringify(data.user));
            
            // Show success message with User ID
            document.getElementById('user-id-display').textContent = data.user.user_id;
            document.getElementById('success-message').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            
            showMessage('Account created successfully!', 'success');
            
            // Redirect to appropriate dashboard based on role
            setTimeout(() => {
                if (data.user.role === 'staff') {
                    window.location.href = '/staff-dashboard';
                } else {
                    window.location.href = '/dashboard';
                }
            }, 5000);
        } else {
            showMessage('Registration failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showMessage('Registration failed: ' + error.message, 'error');
    });
}
</script>
{% endblock %}
