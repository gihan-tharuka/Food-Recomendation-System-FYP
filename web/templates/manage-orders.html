{% extends "staff-base.html" %}

{% block title %}Manage Orders - Staff Dashboard{% endblock %}

{% block page_title %}Manage Orders{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Order Management</h2>
            <p class="text-gray-600">View and manage customer orders</p>
        </div>
        <button onclick="refreshOrders()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center space-x-2">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            <span>Refresh</span>
        </button>
    </div>

    <!-- Order Filters -->
    <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap items-center gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Filter</label>
                    <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready">Ready</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <select id="date-filter" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <input type="text" id="search-input" placeholder="Search by order ID or customer name" 
                               class="border border-gray-300 rounded-md px-3 py-2 w-64 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="applyFilters()" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearFilters()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Orders Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Orders</p>
                        <p id="total-orders" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <i data-lucide="clipboard-list" class="w-8 h-8 text-gray-400"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Pending</p>
                        <p id="pending-orders" class="text-2xl font-bold text-yellow-600">-</p>
                    </div>
                    <i data-lucide="clock" class="w-8 h-8 text-yellow-400"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Preparing</p>
                        <p id="preparing-orders" class="text-2xl font-bold text-orange-600">-</p>
                    </div>
                    <i data-lucide="chef-hat" class="w-8 h-8 text-orange-400"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Ready</p>
                        <p id="ready-orders" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <i data-lucide="check-circle" class="w-8 h-8 text-green-400"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Delivered</p>
                        <p id="delivered-orders" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <i data-lucide="truck" class="w-8 h-8 text-blue-400"></i>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading orders...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12 bg-white rounded-lg shadow-sm border">
            <i data-lucide="inbox" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No orders found</h3>
            <p class="text-gray-500">No orders match your current filters.</p>
        </div>

        <!-- Orders Table -->
        <div id="orders-container" class="hidden bg-white rounded-lg shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Orders will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div id="orders-pagination-container" class="hidden px-6 py-4 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 text-sm text-gray-700">
                        <span>Showing</span>
                        <span id="orders-items-start">1</span>
                        <span>to</span>
                        <span id="orders-items-end">10</span>
                        <span>of</span>
                        <span id="orders-total-items-count">0</span>
                        <span>orders</span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-1 text-sm text-gray-700">
                            <span>Orders per page:</span>
                            <select id="orders-items-per-page" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-1">
                            <button id="orders-prev-page" onclick="changeOrdersPage(ordersCurrentPage - 1)" 
                                    class="px-3 py-1 border border-gray-300 rounded text-sm bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            
                            <div id="orders-page-numbers" class="flex items-center space-x-1">
                                <!-- Page numbers will be populated here -->
                            </div>
                            
                            <button id="orders-next-page" onclick="changeOrdersPage(ordersCurrentPage + 1)" 
                                    class="px-3 py-1 border border-gray-300 rounded text-sm bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Order Details</h3>
                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="order-details-content" class="p-6">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Update Order Status</h3>
                <button onclick="closeStatusModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Order ID</label>
                    <p id="status-order-id" class="text-lg font-semibold text-gray-900"></p>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Status</label>
                    <select id="new-status" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready">Ready</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeStatusModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button onclick="updateOrderStatus()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let allOrders = [];
    let filteredOrders = [];
    let currentOrderId = null;

    // Pagination variables for orders
    let ordersCurrentPage = 1;
    let ordersItemsPerPage = 10;
    let ordersFilteredItems = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();
        loadOrders();
        setupEventListeners();
    });

    function checkAuthentication() {
        const userData = sessionStorage.getItem('currentUser');
        if (!userData) {
            window.location.href = '/login';
            return;
        }
        
        currentUser = JSON.parse(userData);
        
        // Check if user is staff
        if (currentUser.role !== 'staff') {
            window.location.href = '/dashboard';
            return;
        }
    }

    function setupEventListeners() {
        // Add event listeners for filters
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('date-filter').addEventListener('change', applyFilters);
        document.getElementById('search-input').addEventListener('input', applyFilters);
        
        // Pagination for orders
        document.getElementById('orders-items-per-page').addEventListener('change', function() {
            ordersItemsPerPage = parseInt(this.value);
            ordersCurrentPage = 1;
            displayOrders(ordersFilteredItems);
        });
    }

    function loadOrders() {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('orders-container').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        
        fetch('/api/orders/all')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-state').classList.add('hidden');
                
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = data.orders;
                    filteredOrders = [...allOrders];
                    ordersFilteredItems = [...allOrders]; // Initialize filtered items for pagination
                    displayOrders(ordersFilteredItems);
                    updateOrdersSummary(filteredOrders);
                } else {
                    document.getElementById('empty-state').classList.remove('hidden');
                    updateOrdersSummary([]);
                }
            })
            .catch(error => {
                document.getElementById('loading-state').classList.add('hidden');
                console.error('Error loading orders:', error);
                showMessage('Failed to load orders', 'error');
                document.getElementById('empty-state').classList.remove('hidden');
                updateOrdersSummary([]);
            });
    }

    function displayOrders(orders) {
        const tableBody = document.getElementById('orders-table-body');
        
        if (orders.length === 0) {
            document.getElementById('orders-container').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('orders-pagination-container').classList.add('hidden');
            return;
        }
        
        document.getElementById('orders-container').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('orders-pagination-container').classList.remove('hidden');
        
        // Calculate pagination
        const totalItems = orders.length;
        const totalPages = Math.ceil(totalItems / ordersItemsPerPage);
        const startIndex = (ordersCurrentPage - 1) * ordersItemsPerPage;
        const endIndex = Math.min(startIndex + ordersItemsPerPage, totalItems);
        const currentItems = orders.slice(startIndex, endIndex);
        
        // Update pagination info
        document.getElementById('orders-items-start').textContent = totalItems > 0 ? startIndex + 1 : 0;
        document.getElementById('orders-items-end').textContent = endIndex;
        document.getElementById('orders-total-items-count').textContent = totalItems;
        
        tableBody.innerHTML = currentItems.map(order => {
            const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-blue-100 text-blue-800',
                'preparing': 'bg-orange-100 text-orange-800',
                'ready': 'bg-green-100 text-green-800',
                'delivered': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            
            const statusColor = statusColors[order.order_status] || 'bg-gray-100 text-gray-800';
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">#${order.order_id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${order.customer_name}</div>
                        <div class="text-sm text-gray-500">${order.customer_email || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${order.item_count || 0} items</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">$${parseFloat(order.total_amount).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${order.order_status.charAt(0).toUpperCase() + order.order_status.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${orderDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="viewOrderDetails(${order.order_id})" 
                                class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded transition-colors">
                            <i data-lucide="eye" class="w-4 h-4 inline mr-1"></i>View
                        </button>
                        <button onclick="showStatusModal(${order.order_id}, '${order.order_status}')" 
                                class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 px-2 py-1 rounded transition-colors">
                            <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>Status
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Update pagination controls
        updateOrdersPaginationControls(totalPages);
        
        lucide.createIcons();
    }

    function updateOrdersSummary(orders) {
        const total = orders.length;
        const pending = orders.filter(o => o.order_status === 'pending').length;
        const preparing = orders.filter(o => o.order_status === 'preparing').length;
        const ready = orders.filter(o => o.order_status === 'ready').length;
        const delivered = orders.filter(o => o.order_status === 'delivered').length;
        
        document.getElementById('total-orders').textContent = total;
        document.getElementById('pending-orders').textContent = pending;
        document.getElementById('preparing-orders').textContent = preparing;
        document.getElementById('ready-orders').textContent = ready;
        document.getElementById('delivered-orders').textContent = delivered;
    }

    function applyFilters() {
        const statusFilter = document.getElementById('status-filter').value;
        const dateFilter = document.getElementById('date-filter').value;
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        filteredOrders = allOrders.filter(order => {
            // Status filter
            if (statusFilter && order.order_status !== statusFilter) {
                return false;
            }
            
            // Date filter
            if (dateFilter) {
                const orderDate = new Date(order.order_date);
                const now = new Date();
                
                switch (dateFilter) {
                    case 'today':
                        if (orderDate.toDateString() !== now.toDateString()) return false;
                        break;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (orderDate < weekAgo) return false;
                        break;
                    case 'month':
                        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        if (orderDate < monthAgo) return false;
                        break;
                }
            }
            
            // Search filter
            if (searchTerm) {
                const searchableText = `${order.order_id} ${order.customer_name}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }
            
            return true;
        });
        
        ordersFilteredItems = [...filteredOrders]; // Update pagination filtered items
        ordersCurrentPage = 1; // Reset to first page when filtering
        displayOrders(ordersFilteredItems);
        updateOrdersSummary(filteredOrders);
    }

    function clearFilters() {
        document.getElementById('status-filter').value = '';
        document.getElementById('date-filter').value = '';
        document.getElementById('search-input').value = '';
        filteredOrders = [...allOrders];
        ordersFilteredItems = [...allOrders]; // Update pagination filtered items
        ordersCurrentPage = 1; // Reset to first page
        displayOrders(ordersFilteredItems);
        updateOrdersSummary(filteredOrders);
    }

    function refreshOrders() {
        loadOrders();
        showMessage('Orders refreshed', 'success');
    }

    function viewOrderDetails(orderId) {
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.order) {
                    displayOrderDetailsModal(data.order);
                } else {
                    showMessage('Failed to load order details', 'error');
                }
            })
            .catch(error => {
                console.error('Error loading order details:', error);
                showMessage('Failed to load order details', 'error');
            });
    }

    function displayOrderDetailsModal(orderData) {
        const content = document.getElementById('order-details-content');
        const order = orderData[0]; // Get first row for order info
        
        const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const statusColors = {
            'pending': 'bg-yellow-100 text-yellow-800',
            'confirmed': 'bg-blue-100 text-blue-800',
            'preparing': 'bg-orange-100 text-orange-800',
            'ready': 'bg-green-100 text-green-800',
            'delivered': 'bg-green-100 text-green-800',
            'cancelled': 'bg-red-100 text-red-800'
        };
        
        const statusColor = statusColors[order.order_status] || 'bg-gray-100 text-gray-800';
        
        content.innerHTML = `
            <!-- Order Header -->
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="text-xl font-bold text-gray-800">Order #${order.order_id}</h4>
                        <p class="text-gray-600">${orderDate}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                        ${order.order_status.charAt(0).toUpperCase() + order.order_status.slice(1)}
                    </span>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Customer</p>
                        <p class="font-semibold">${order.customer_name}</p>
                        <p class="text-sm text-gray-500">${order.customer_email}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Payment Method</p>
                        <p class="font-semibold">${order.payment_method.charAt(0).toUpperCase() + order.payment_method.slice(1)}</p>
                    </div>
                </div>
                
                ${order.notes ? `
                    <div class="mt-4">
                        <p class="text-sm text-gray-600">Special Instructions</p>
                        <p class="text-gray-800">${order.notes}</p>
                    </div>
                ` : ''}
            </div>
            
            <!-- Order Items -->
            <div class="mb-6">
                <h5 class="text-lg font-semibold text-gray-800 mb-4">Order Items</h5>
                <div class="space-y-3">
                    ${orderData.filter(item => item.item_id).map(item => `
                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div class="flex-1">
                                <h6 class="font-medium text-gray-800">${item.item_name}</h6>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${item.cuisine}</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">${item.category}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">$${parseFloat(item.item_price).toFixed(2)} × ${item.quantity}</p>
                                ${item.special_instructions ? `<p class="text-xs text-orange-600 mt-1">Note: ${item.special_instructions}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-gray-800">$${parseFloat(item.subtotal).toFixed(2)}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Order Total -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex justify-between items-center text-lg font-bold text-gray-800">
                    <span>Total Amount</span>
                    <span>$${parseFloat(order.total_amount).toFixed(2)}</span>
                </div>
            </div>
        `;
        
        document.getElementById('order-details-modal').classList.remove('hidden');
        lucide.createIcons();
    }

    function closeOrderDetailsModal() {
        document.getElementById('order-details-modal').classList.add('hidden');
    }

    function showStatusModal(orderId, currentStatus) {
        currentOrderId = orderId;
        document.getElementById('status-order-id').textContent = `#${orderId}`;
        document.getElementById('new-status').value = currentStatus;
        document.getElementById('status-modal').classList.remove('hidden');
    }

    function closeStatusModal() {
        document.getElementById('status-modal').classList.add('hidden');
        currentOrderId = null;
    }

    function updateOrderStatus() {
        if (!currentOrderId) return;
        
        const newStatus = document.getElementById('new-status').value;
        
        fetch(`/api/orders/${currentOrderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Order status updated successfully', 'success');
                closeStatusModal();
                loadOrders(); // Refresh the orders list
            } else {
                showMessage('Failed to update order status', 'error');
            }
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            showMessage('Failed to update order status', 'error');
        });
    }

    function showMessage(text, type = 'info') {
        const message = document.createElement('div');
        message.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50 transform translate-x-full transition-transform duration-300';
        
        if (type === 'success') {
            message.className += ' bg-green-500';
        } else if (type === 'error') {
            message.className += ' bg-red-500';
        } else {
            message.className += ' bg-blue-500';
        }
        
        message.textContent = text;
        document.body.appendChild(message);
        
        // Animate in
        setTimeout(() => {
            message.classList.remove('translate-x-full');
        }, 100);
        
        // Remove after delay
        setTimeout(() => {
            message.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(message);
            }, 300);
        }, 3000);
    }

    // Orders Pagination Functions
    function updateOrdersPaginationControls(totalPages) {
        const prevButton = document.getElementById('orders-prev-page');
        const nextButton = document.getElementById('orders-next-page');
        const pageNumbers = document.getElementById('orders-page-numbers');
        
        // Update prev/next buttons
        prevButton.disabled = ordersCurrentPage === 1;
        nextButton.disabled = ordersCurrentPage === totalPages || totalPages === 0;
        
        // Generate page numbers
        pageNumbers.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Calculate page range to show
        const maxPagesToShow = 5;
        let startPage = Math.max(1, ordersCurrentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxPagesToShow - 1) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
        
        // Show first page and ellipsis if needed
        if (startPage > 1) {
            pageNumbers.appendChild(createOrdersPageButton(1));
            if (startPage > 2) {
                pageNumbers.appendChild(createOrdersEllipsis());
            }
        }
        
        // Show page numbers
        for (let i = startPage; i <= endPage; i++) {
            pageNumbers.appendChild(createOrdersPageButton(i));
        }
        
        // Show ellipsis and last page if needed
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                pageNumbers.appendChild(createOrdersEllipsis());
            }
            pageNumbers.appendChild(createOrdersPageButton(totalPages));
        }
    }
    
    function createOrdersPageButton(pageNum) {
        const button = document.createElement('button');
        button.textContent = pageNum;
        button.className = `px-3 py-1 border text-sm ${
            ordersCurrentPage === pageNum 
                ? 'bg-indigo-600 text-white border-indigo-600' 
                : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
        }`;
        button.onclick = () => changeOrdersPage(pageNum);
        return button;
    }
    
    function createOrdersEllipsis() {
        const span = document.createElement('span');
        span.textContent = '...';
        span.className = 'px-2 py-1 text-gray-500';
        return span;
    }
    
    function changeOrdersPage(newPage) {
        const totalPages = Math.ceil(ordersFilteredItems.length / ordersItemsPerPage);
        
        if (newPage < 1 || newPage > totalPages) return;
        
        ordersCurrentPage = newPage;
        displayOrders(ordersFilteredItems);
    }

    // Initialize Lucide icons
    lucide.createIcons();
</script>
{% endblock %}
