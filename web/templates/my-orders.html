{% extends "base.html" %}

{% block title %}ðŸ“‹ My Orders - Food Recommendation System{% endblock %}

{% block content %}
<!-- Orders Header -->
<div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
            <div class="bg-food-blue bg-opacity-20 rounded-full p-3 mr-4">
                <i data-lucide="list" class="w-8 h-8 text-food-blue"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-800">My Orders</h1>
                <p class="text-gray-600">Track and manage your food orders</p>
            </div>
        </div>
        <div class="flex space-x-3">
            <a href="/recommend" class="bg-food-green text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span>New Order</span>
            </a>
        </div>
    </div>
</div>

<!-- Orders Content -->
<div class="bg-white rounded-2xl shadow-xl p-8">
    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-food-green mx-auto mb-4"></div>
        <p class="text-gray-600">Loading your orders...</p>
    </div>
    
    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
        <i data-lucide="package" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No orders yet</h3>
        <p class="text-gray-500 mb-6">Start by getting personalized food recommendations!</p>
        <a href="/recommend" class="bg-food-green text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors inline-flex items-center space-x-2">
            <i data-lucide="utensils" class="w-5 h-5"></i>
            <span>Get Recommendations</span>
        </a>
    </div>
    
    <!-- Orders List -->
    <div id="orders-list" class="hidden space-y-6">
        <!-- Orders will be populated here -->
    </div>
</div>

<!-- Order Details Modal -->
<div id="order-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Order Details</h3>
                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[70vh]">
            <div id="order-details-content">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentUser = null;
let orders = [];

// Check authentication and load orders on page load
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    loadOrders();
});

function checkAuthentication() {
    const userData = sessionStorage.getItem('currentUser');
    if (!userData) {
        window.location.href = '/login';
        return;
    }
    currentUser = JSON.parse(userData);
}

function loadOrders() {
    fetch(`/api/orders/user/${currentUser.id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-state').classList.add('hidden');
            
            if (data.success && data.orders && data.orders.length > 0) {
                orders = data.orders;
                displayOrders(orders);
            } else {
                document.getElementById('empty-state').classList.remove('hidden');
            }
        })
        .catch(error => {
            document.getElementById('loading-state').classList.add('hidden');
            console.error('Error loading orders:', error);
            document.getElementById('empty-state').classList.remove('hidden');
        });
}

function displayOrders(orders) {
    const ordersList = document.getElementById('orders-list');
    
    ordersList.innerHTML = orders.map(order => {
        const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const statusColors = {
            'pending': 'bg-yellow-100 text-yellow-800',
            'confirmed': 'bg-blue-100 text-blue-800',
            'preparing': 'bg-orange-100 text-orange-800',
            'ready': 'bg-green-100 text-green-800',
            'delivered': 'bg-green-100 text-green-800',
            'cancelled': 'bg-red-100 text-red-800'
        };
        
        const statusColor = statusColors[order.order_status] || 'bg-gray-100 text-gray-800';
        
        return `
            <div class="border border-gray-200 rounded-lg p-6 hover:border-food-green transition-colors">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Order #${order.order_id}</h3>
                        <p class="text-gray-600 text-sm">${orderDate}</p>
                    </div>
                    <div class="text-right">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                            ${order.order_status.charAt(0).toUpperCase() + order.order_status.slice(1)}
                        </span>
                        <p class="text-lg font-bold text-gray-800 mt-1">$${parseFloat(order.total_amount).toFixed(2)}</p>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-600">Items</p>
                        <p class="font-semibold">${order.item_count} item${order.item_count > 1 ? 's' : ''}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Payment</p>
                        <p class="font-semibold">${order.payment_method.charAt(0).toUpperCase() + order.payment_method.slice(1)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Customer</p>
                        <p class="font-semibold">${order.customer_name}</p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                    <button onclick="viewOrderDetails(${order.order_id})" 
                            class="bg-food-blue text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                        <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                        View Details
                    </button>
                    
                    <div class="flex space-x-2">
                        ${order.order_status === 'delivered' ? `
                            <button onclick="reorder(${order.order_id})" 
                                    class="bg-food-green text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                <i data-lucide="repeat" class="w-4 h-4 inline mr-2"></i>
                                Reorder
                            </button>
                        ` : ''}
                        
                        ${order.order_status === 'pending' ? `
                            <button onclick="cancelOrder(${order.order_id})" 
                                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                                <i data-lucide="x-circle" class="w-4 h-4 inline mr-2"></i>
                                Cancel
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    ordersList.classList.remove('hidden');
    lucide.createIcons();
}

function viewOrderDetails(orderId) {
    fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.order) {
                displayOrderDetailsModal(data.order);
            } else {
                alert('Failed to load order details');
            }
        })
        .catch(error => {
            console.error('Error loading order details:', error);
            alert('Failed to load order details');
        });
}

function displayOrderDetailsModal(orderData) {
    const content = document.getElementById('order-details-content');
    
    // Group items by order (should be one order but data might have multiple rows for items)
    const order = orderData[0]; // Get first row for order info
    
    const orderDate = new Date(order.order_date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const statusColors = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'confirmed': 'bg-blue-100 text-blue-800',
        'preparing': 'bg-orange-100 text-orange-800',
        'ready': 'bg-green-100 text-green-800',
        'delivered': 'bg-green-100 text-green-800',
        'cancelled': 'bg-red-100 text-red-800'
    };
    
    const statusColor = statusColors[order.order_status] || 'bg-gray-100 text-gray-800';
    
    content.innerHTML = `
        <!-- Order Header -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 class="text-xl font-bold text-gray-800">Order #${order.order_id}</h4>
                    <p class="text-gray-600">${orderDate}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                    ${order.order_status.charAt(0).toUpperCase() + order.order_status.slice(1)}
                </span>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600">Customer</p>
                    <p class="font-semibold">${order.customer_name}</p>
                    <p class="text-sm text-gray-500">${order.customer_email}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Payment Method</p>
                    <p class="font-semibold">${order.payment_method.charAt(0).toUpperCase() + order.payment_method.slice(1)}</p>
                </div>
            </div>
            
            ${order.notes ? `
                <div class="mt-4">
                    <p class="text-sm text-gray-600">Special Instructions</p>
                    <p class="text-gray-800">${order.notes}</p>
                </div>
            ` : ''}
        </div>
        
        <!-- Order Items -->
        <div class="mb-6">
            <h5 class="text-lg font-semibold text-gray-800 mb-4">Order Items</h5>
            <div class="space-y-3">
                ${orderData.filter(item => item.item_id).map(item => `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <div class="flex-1">
                            <h6 class="font-medium text-gray-800">${item.item_name}</h6>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${item.cuisine}</span>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">${item.category}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">$${parseFloat(item.item_price).toFixed(2)} Ã— ${item.quantity}</p>
                            ${item.special_instructions ? `<p class="text-xs text-orange-600 mt-1">Note: ${item.special_instructions}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-800">$${parseFloat(item.subtotal).toFixed(2)}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Order Total -->
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex justify-between items-center text-lg font-bold text-gray-800">
                <span>Total Amount</span>
                <span>$${parseFloat(order.total_amount).toFixed(2)}</span>
            </div>
        </div>
    `;
    
    document.getElementById('order-details-modal').classList.remove('hidden');
    lucide.createIcons();
}

function closeOrderDetailsModal() {
    document.getElementById('order-details-modal').classList.add('hidden');
}

function reorder(orderId) {
    if (confirm('Add all items from this order to your cart?')) {
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.order) {
                    // Get items from the order
                    const items = data.order.filter(item => item.item_id);
                    
                    // Add to cart
                    const cart = [];
                    items.forEach(item => {
                        cart.push({
                            item_id: item.item_id,
                            item_name: item.item_name,
                            price: parseFloat(item.item_price),
                            cuisine: item.cuisine,
                            category: item.category,
                            quantity: item.quantity,
                            special_instructions: item.special_instructions || ''
                        });
                    });
                    
                    // Save to local storage and redirect to cart
                    localStorage.setItem('cart', JSON.stringify(cart));
                    showMessage('Items added to cart!', 'success');
                    
                    setTimeout(() => {
                        window.location.href = '/cart';
                    }, 1500);
                } else {
                    alert('Failed to load order for reordering');
                }
            })
            .catch(error => {
                console.error('Error reordering:', error);
                alert('Failed to reorder');
            });
    }
}

function cancelOrder(orderId) {
    if (confirm('Are you sure you want to cancel this order?')) {
        fetch(`/api/orders/${orderId}/cancel`, {
            method: 'PUT'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Order cancelled successfully', 'success');
                loadOrders(); // Reload orders
            } else {
                alert('Failed to cancel order: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error cancelling order:', error);
            alert('Failed to cancel order');
        });
    }
}

function showMessage(text, type) {
    // Create message element
    const message = document.createElement('div');
    message.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transition-all transform translate-x-full`;
    
    if (type === 'success') {
        message.className += ' bg-green-500 text-white';
    } else {
        message.className += ' bg-red-500 text-white';
    }
    
    message.textContent = text;
    document.body.appendChild(message);
    
    // Animate in
    setTimeout(() => {
        message.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after delay
    setTimeout(() => {
        message.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(message);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}
